<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div x-data="jiraProjectSearch()" class="jira-project-search">
    <label for="project-search"><strong>S√©lectionner mon Projet Jira : </strong></label>

    <input
        id="project-search"
        type="text"
        x-model="query"
        @input.debounce.300ms="search()"
        @focus="open = true"
        class="input"
        placeholder="Ex: ABC, My Project..."
        autocomplete="off" />

    <!-- Dropdown -->
    <div class="project-dropdown"
        x-show="open && projects.length"
        @click.outside="open = false">
        <template x-for="project in projects" :key="project.id">
            <div
                @click="select(project)"
                style="padding: 8px 12px; cursor: pointer;"
                class="hover-bg">
                <strong x-text="project.key"></strong>
                <span x-text="' ‚Äì ' + project.name"></span>
            </div>
        </template>
    </div>

    <!-- Projet s√©lectionn√© -->
    <div x-show="selected">
        <div style="margin-top: 8px; font-size: 14px;">
            ‚úÖ Projet s√©lectionn√© : <strong x-text="selected.key"></strong>
            <button type="button" @click="reset()" style="font-size: 12px; cursor: pointer;">
                üîÑ Changer de projet
            </button>
        </div>

        <!-- Versions du projet selectionn√© -->
        <div x-show="versions.length" style="margin-top: 16px;">
            <form method="POST" action="/version" style="margin-top: 16px;">
                <label><strong>S√©lectionner la Version :</strong></label>

                <select
                    name="fixVersionId"
                    class="input"
                    required
                    @change="$el.form.submit()">

                    <option value="" disabled selected>
                        -- Choisir une version --
                    </option>

                    <template x-for="version in versions" :key="version.id">
                        <option
                            :value="version.id"
                            x-text="`${version.name} (${version.status})`">
                        </option>
                    </template>
                </select>
            </form>
        </div>

        <div x-show="!versionLoading && versions.length === 0 && !versionError" style="margin-top: 16px; font-style: italic; color: #ff0000;">
            ‚ö†Ô∏è Pas de version Jira trouv√©e pour ce projet
        </div>

        <div x-show="versionLoading">‚è≥ Loading versions‚Ä¶</div>

        <div x-show="error" class="inline-error">
            ‚ùå <span x-text="error"></span>
        </div>
        <div x-show="versionError" class="inline-error">
            ‚ùå <span x-text="versionError"></span>
        </div>
    </div>
</div>

<script>
    function jiraProjectSearch() {
        return {
            _storageKey: 'jira_selected_project',

            query: '',
            open: false,
            projects: [],
            selected: null,
            loading: false,
            error: null,
            versions: [],
            versionLoading: false,
            versionError: null,

            /**
             * Restaure l'√©tat depuis localStorage au chargement du composant.
             * Appel√© automatiquement par Alpine.js.
             */
            init() {
                try {
                    const saved = localStorage.getItem(this._storageKey);
                    if (!saved) return;

                    const {
                        project,
                        versions
                    } = JSON.parse(saved);
                    if (project && versions) {
                        this.selected = project;
                        this.versions = versions;
                        this.query = project.key + ' ‚Äì ' + project.name;
                    }
                } catch (e) {
                    // Donn√©es corrompues ‚Üí on ignore silencieusement
                    localStorage.removeItem(this._storageKey);
                }
            },

            /**
             * Persiste le projet s√©lectionn√© et ses versions dans localStorage.
             */
            _saveToStorage() {
                try {
                    localStorage.setItem(this._storageKey, JSON.stringify({
                        project: this.selected,
                        versions: this.versions,
                    }));
                } catch (e) {
                    console.warn('localStorage indisponible', e);
                }
            },

            /**
             * R√©initialise la s√©lection et supprime le cache localStorage.
             */
            reset() {
                this.selected = null;
                this.versions = [];
                this.query = '';
                this.projects = [];
                this.error = null;
                this.versionError = null;
                localStorage.removeItem(this._storageKey);
            },

            search() {
                if (this.query.length < 2) {
                    this.projects = [];
                    return;
                }
                this.loading = true;
                fetch('/api/jira/projects/search?q=' + encodeURIComponent(this.query))
                    .then(response => {
                        if (!response.ok) throw new Error('HTTP error ' + response.status);
                        return response.json();
                    })
                    .then(data => {
                        this.projects = data;
                        this.open = true;
                    })
                    .catch(err => {
                        console.error(err);
                        this.error = 'Failed to load projects';
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },

            select(project) {
                this.selected = project;
                this.query = project.key + ' ‚Äì ' + project.name;
                this.open = false;
                this.loadVersions();
            },

            loadVersions() {
                this.versionLoading = true;
                this.versionError = null;
                this.versions = [];

                fetch(`/api/jira/projects/${this.selected.key}/versions`)
                    .then(r => {
                        if (!r.ok) throw new Error('HTTP ' + r.status);
                        return r.json();
                    })
                    .then(data => {
                        this.versions = data;
                        this._saveToStorage(); // ‚Üê persist apr√®s chargement r√©ussi
                    })
                    .catch(err => {
                        console.error(err);
                        this.versionError = err.message;
                    })
                    .finally(() => {
                        this.versionLoading = false;
                    });
            }
        }
    }
</script>