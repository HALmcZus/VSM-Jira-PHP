<?php

/** @var array $timelineData */
/** @var \App\View\VersionView $view */

$timelineData = $view->getTimelineByStatus();
$chartData = array_merge(
    $timelineData['workflowStatuses'] ?? [],
    $timelineData['otherStatuses'] ?? []
);

$normalizedLabels = array_map(fn($status) => $view->normalizeStatusName($status), array_keys($chartData));
?>

<div class="card">
    <details>
        <summary>üß≠ Timeline globale par statut (cumul tickets de la Release, hors Termin√©s)</summary>

        <div class="vsm-layout">
            <div class="vsm-text">
                <ul>
                    <?php foreach ($timelineData['workflowStatuses'] as $status => $days): ?>
                        <li><?= $view->normalizeStatusName($status); ?> : <strong><?= round($days, 2); ?> jours</strong></li>
                    <?php endforeach; ?>
                    <?php if (!empty($timelineData['otherStatuses'])): ?>
                        <br />Autres statuts :
                        <?php foreach ($timelineData['otherStatuses'] as $status => $days): ?>
                            <li><?= $view->normalizeStatusName($status); ?> : <strong><?= round($days, 2); ?> jours</strong></li>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </ul>
            </div>

            <!-- Chart container -->
            <div class="vsm-chart">
                <canvas id="timelineChart"></canvas>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const chartLabels = <?= json_encode($normalizedLabels, JSON_HEX_TAG) ?>;
                const chartValues = <?= json_encode(array_values($chartData), JSON_HEX_TAG) ?>;

                const chartColors = chartLabels.map(label => {
                    if (label.startsWith('üß†')) return '#36a2ebb3';
                    if (label.startsWith('‚öôÔ∏è')) return '#ffce56b3';
                    if (label.startsWith('‚ùì')) return '#ff6384b3';
                    return '#c9cbcfb3';
                });

                const ctx = document.getElementById('timelineChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Jours par statut',
                            data: chartValues,
                            backgroundColor: chartColors,
                            borderColor: chartColors.map(c => c.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Jours'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Statuts'
                                }
                            }
                        }
                    }
                });
            </script>
        </div>

        <?php $waitingTimes = $view->getAggregatedWaitingTimes(); ?>
        <?php if (!empty($waitingTimes)): ?>
            <div class="waiting-times-summary">
                <h4>‚è≥ Temps de blocage cumul√©s (labels "attente" des tickets)</h4>
                <ul>
                    <?php foreach ($waitingTimes as $label => $days): ?>
                        <li>
                            <span class="waiting-label"><?= htmlspecialchars($label) ?></span>
                            <strong><?= round($days, 1) ?> jours</strong>
                        </li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>

        <?php include __DIR__ . '/vsm.phtml'; ?>
    </details>
</div>